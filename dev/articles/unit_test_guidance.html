<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Unit Test Guidance • admiraldev</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Unit Test Guidance">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">admiraldev</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.1.0.9006</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/admiraldev.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-developer-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Developer Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-developer-guides">
<li><a class="dropdown-item" href="../articles/programming_strategy.html">Programming Strategy</a></li>
    <li><a class="dropdown-item" href="../articles/writing_vignettes.html">Writing Vignettes</a></li>
    <li><a class="dropdown-item" href="../articles/unit_test_guidance.html">Unit Test Guidance</a></li>
    <li><a class="dropdown-item" href="../articles/git_usage.html">Guidance for git and GitHub Usage</a></li>
    <li><a class="dropdown-item" href="../articles/pr_review_guidance.html">Pull Request Review Guidance</a></li>
    <li><a class="dropdown-item" href="../articles/rcmd_issues.html">R CMD Issues</a></li>
    <li><a class="dropdown-item" href="../articles/release_strategy.html">Release Strategy</a></li>
    <li><a class="dropdown-item" href="../articles/test_data_guidance.html">Test Data Guidance</a></li>
    <li><a class="dropdown-item" href="../articles/package_extensions.html">Package Extensions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pharmaverse/admiraldev" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Unit Test Guidance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pharmaverse/admiraldev/blob/main/vignettes/unit_test_guidance.Rmd" class="external-link"><code>vignettes/unit_test_guidance.Rmd</code></a></small>
      <div class="d-none name"><code>unit_test_guidance.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="why-write-unit-tests">Why Write Unit Tests?<a class="anchor" aria-label="anchor" href="#why-write-unit-tests"></a>
</h2>
<div class="section level3">
<h3 id="unit-tests-become-a-safety-net-for-developers">Unit Tests Become a Safety Net for Developers<a class="anchor" aria-label="anchor" href="#unit-tests-become-a-safety-net-for-developers"></a>
</h3>
<p>A comprehensive suite of unit tests can act as a safety net for
developers. By frequently running the tests, they can assure their
recent modifications to the code haven’t broken anything. In other
words, unit tests help prevent regressions.</p>
</div>
<div class="section level3">
<h3 id="unit-tests-can-contribute-to-higher-code-quality">Unit Tests Can Contribute to Higher Code Quality<a class="anchor" aria-label="anchor" href="#unit-tests-can-contribute-to-higher-code-quality"></a>
</h3>
<p>Since unit tests act as a safety net, developers become more
confident when changing the code. They can refactor the code without
fear of breaking things, driving the general quality of the code base
up.</p>
</div>
<div class="section level3">
<h3 id="unit-tests-can-contribute-to-better-application-architecture">Unit Tests Can Contribute to Better Application Architecture<a class="anchor" aria-label="anchor" href="#unit-tests-can-contribute-to-better-application-architecture"></a>
</h3>
<p>If you can add unit tests easily to a code base, that’s usually a
good sign regarding the quality of the app’s architecture. So, the drive
to write testable code can be an incentive for better architecture.</p>
</div>
<div class="section level3">
<h3 id="detects-code-smells-in-your-codebase">Detects Code Smells in your Codebase<a class="anchor" aria-label="anchor" href="#detects-code-smells-in-your-codebase"></a>
</h3>
<p>If ease of adding unit tests to a code base is a good sign, the
opposite is also true. Having a hard time creating unit tests for a
given piece of code might be a sign of code smells in the
code—e.g. functions that are too complex.</p>
</div>
</div>
<div class="section level2">
<h2 id="writing-good-unit-tests">Writing Good Unit Tests<a class="anchor" aria-label="anchor" href="#writing-good-unit-tests"></a>
</h2>
<div class="section level3">
<h3 id="tests-should-be-fast">Tests Should Be Fast<a class="anchor" aria-label="anchor" href="#tests-should-be-fast"></a>
</h3>
<p>If they’re slow, developers won’t run them as often as they should.
That defeats the whole purpose of having a suite of unit tests in the
first place, which is to boost the developers’ confidence to make
changes to the code. The tests can’t work as the safety net if they’re
not run often.</p>
</div>
<div class="section level3">
<h3 id="tests-should-be-simple">Tests Should Be Simple<a class="anchor" aria-label="anchor" href="#tests-should-be-simple"></a>
</h3>
<p>There are several techniques we can apply to have a high degree of
confidence in the correctness of our tests. One of those is to keep your
tests with low cyclomatic complexity. Cyclomatic complexity is a code
metric that indicates the number of possible execution paths a given
method can follow. A piece of code with lower complexity is easier to
understand and maintain, which means developers are less likely to
introduce bugs when working on it. We can measure the cyclomatic
complexity of your tests (using, for instance, a linter tool) and do
your best to keep it low.</p>
</div>
<div class="section level3">
<h3 id="test-shouldnt-duplicate-implementation-logic">Test Shouldn’t Duplicate Implementation Logic<a class="anchor" aria-label="anchor" href="#test-shouldnt-duplicate-implementation-logic"></a>
</h3>
<p>If the same person wrote both the test and the implementation, it’s
possible they made the same errors in both places. Since the tests
mirror the implementation, they might still pass, and the implementation
could be wrong, but the tests might fool you into thinking otherwise.
Resist the urge to make your tests fancy, keep them simple, and your
testing suite will be better for it.</p>
</div>
<div class="section level3">
<h3 id="tests-should-be-readable">Tests Should Be Readable<a class="anchor" aria-label="anchor" href="#tests-should-be-readable"></a>
</h3>
<p>This best practice overlaps a little bit with the one about keeping
your tests simple. If tests are hard to read, developers are more likely
to misunderstand them and introduce bugs. Test cases could be used as a
form of documentation, so they obviously need to be readable.</p>
</div>
<div class="section level3">
<h3 id="running-unit-tests-part-of-the-build-process">Running Unit Tests Part of the Build Process<a class="anchor" aria-label="anchor" href="#running-unit-tests-part-of-the-build-process"></a>
</h3>
<p>Automate the whole process of running the unit tests and taking some
action when they fail. Your build process should execute your unit tests
and mark the build as broken when the tests fail.</p>
</div>
</div>
<div class="section level2">
<h2 id="writing-unit-tests-in-admiral">Writing Unit Tests in {admiral}<a class="anchor" aria-label="anchor" href="#writing-unit-tests-in-admiral"></a>
</h2>
<div class="section level3">
<h3 id="plan-your-unit-tests">Plan your Unit Tests<a class="anchor" aria-label="anchor" href="#plan-your-unit-tests"></a>
</h3>
<p>Start by considering the derivation rule you are testing and the
possible arguments/flexibilities of your function code. Then plan which
scenarios you will test. These can either involve generating different
input test cases or feeding them into different calls of your
function.</p>
</div>
<div class="section level3">
<h3 id="test-coverage">Test coverage<a class="anchor" aria-label="anchor" href="#test-coverage"></a>
</h3>
<p>Unit tests should cover the functionality of the function. If another
function <code>g()</code> is called within a function <code>f()</code>,
the unit tests of <code>f()</code> should not test the functionality of
<code>g()</code>. This should be tested by the unit tests of
<code>g()</code>, i.e. unit tests should be added at the lowest
level.</p>
</div>
<div class="section level3">
<h3 id="tests-should-be-robust-to-cover-realistic-data-scenarios">Tests Should be Robust to Cover Realistic Data Scenarios<a class="anchor" aria-label="anchor" href="#tests-should-be-robust-to-cover-realistic-data-scenarios"></a>
</h3>
<p>For generating input test cases, it can be helpful to consider
regular cases (expected common data scenarios), boundary cases (where
data points are close or equal), and special cases (uncommon but valid
data scenarios, e.g. missing or special characters). Although you will
never cover every single eventuality of possible input data (no
reliability testing method ever gives 100% certainty), you do need to
give confidence that the code is robust enough to work across most data
scenarios.</p>
</div>
<div class="section level3">
<h3 id="testing-should-cover-possible-arguments">Testing Should Cover Possible Arguments<a class="anchor" aria-label="anchor" href="#testing-should-cover-possible-arguments"></a>
</h3>
<p>For the different calls of your function, consider how the user might
apply your function and test a variety of possible calls, whilst still
remembering the tips above that tests should be fast and simple. This is
only needed in cases where the complexity and level of flexibility of
your function justifies it, e.g. see the test script: <a href="https://github.com/pharmaverse/admiral/blob/main/tests/testthat/test-derive_var_extreme_flag.R" class="external-link uri">https://github.com/pharmaverse/admiral/blob/main/tests/testthat/test-derive_var_extreme_flag.R</a>.</p>
</div>
<div class="section level3">
<h3 id="exported-functions">Exported Functions<a class="anchor" aria-label="anchor" href="#exported-functions"></a>
</h3>
<p>Don’t forget to add a unit test for each exported function.</p>
</div>
<div class="section level3">
<h3 id="snapshot-testing">Snapshot Testing<a class="anchor" aria-label="anchor" href="#snapshot-testing"></a>
</h3>
<p>Standard unit tests are not always convenient to record the expected
behavior with code. Some challenges include:</p>
<ul>
<li>Output that is large, making it painful to define the reference
output, and bloating the size of the test file and making it hard to
navigate.</li>
<li>Text output that includes many characters like quotes and newlines
that require special handling in a string.<br>
</li>
<li>Binary formats like plots or images, which are very difficult to
describe in code: i.e. the plot looks right, the error message is useful
to a human, the print method uses color effectively.</li>
</ul>
<p>For these situations, testthat provides an alternative mechanism:
snapshot tests. Snapshot tests record results in a separate human
readable file and records the results, including output, messages,
warnings, and errors. Review the <a href="https://testthat.r-lib.org/articles/snapshotting.html" class="external-link">{testthat}
snapshot vignette</a> for details.</p>
</div>
<div class="section level3">
<h3 id="set-up-the-test-script">Set up the Test Script<a class="anchor" aria-label="anchor" href="#set-up-the-test-script"></a>
</h3>
<p>Within the <code>tests/testthat</code> folder of the project, add a
script with the naming convention
<code>test-&lt;script_containing_function&gt;.R</code>., the unit test
script can be created from the console also, as follows:</p>
<pre><code><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_r.html" class="external-link">use_test</a></span><span class="op">(</span><span class="st">"&lt;script_containing_function&gt;"</span><span class="op">)</span></span></code></pre>
<p>the testing framework used is testthat and has the following format
:</p>
<pre><code>## Test 1: &lt;Explanation of the test&gt; ----
test_that("&lt;function_name&gt; Test 1: &lt;Explanation of the test&gt;", {
  
  input &lt;- dplyr::tribble(
    ~inputvar1, ~inputvar2, ...
    &lt;Add Test Data Scenarios&gt;
    ...
  )

  expected_output &lt;- mutate(input, outputvar = c(&lt;Add Expected Outputs&gt;))

  expect_dfs_equal(&lt;function name&gt;(input), expected_output)
  
})</code></pre>
<p>For example, if you are testing a function called
<code>my_new_func</code> that is contained in script
<code>all_funcs.R</code> then from console use:</p>
<pre><code><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_r.html" class="external-link">use_test</a></span><span class="op">(</span><span class="st">"all_funcs"</span><span class="op">)</span></span></code></pre>
<p>Open the newly created file <code>test-all_funcs.R</code> and use the
following format:</p>
<pre><code># my_new_func ----
## Test 1: &lt;Explanation of the test&gt; ----
test_that("my_new_func Test 1: &lt;Explanation of the test&gt;", {
  
  input &lt;- dplyr::tribble(
    ~inputvar1, ~inputvar2, ...
    &lt;Add Test Data Scenarios&gt;
    ...
  )

  expected_output &lt;- mutate(input, outputvar = c(&lt;Add Expected Outputs&gt;))

  expect_dfs_equal(&lt;function name&gt;(input), expected_output)
})</code></pre>
<p><strong>Note</strong>: When comparing datasets in
<a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> we use function
<code><a href="../reference/expect_dfs_equal.html">expect_dfs_equal()</a></code>.</p>
<p>The input and expected output for the unit tests must follow the
following rules:</p>
<ul>
<li>Input and output should be as simple as possible.</li>
<li>Values should be hard-coded whenever possible.</li>
<li>If values need to be derived, only unit tested functions can be
used.</li>
</ul>
<p>In contrast to the <a href="programming_strategy.html#function-header-documentation">Programming
Strategy</a> documentation for function examples, test files should not
include <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library(pkg_name)</a></code> calls. If a dataset needs to be
created for testing purposes, it should be done so using the function
<code><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble()</a></code> from the <code>tibble</code> package with the
following command <code>dplyr::tribble(&lt;data here&gt;)</code>.
Furthermore, if other functions need to be called, it should also be
done using <code>pkg_name::fun()</code>notation. Make sure to align
columns as well. This ensures quick code readability.</p>
<p>Ensure you give a meaningful explanation of the test in the testthat
call, as these will be compiled in the package validation report. Having
the name of the function and test ID included in title will also help
with traceability.</p>
<p>The comments ending with <code>----</code> create entries in the TOC
in RStudio.</p>
<p><img src="unit_test_toc.png" width="120%"></p>
</div>
<div class="section level3">
<h3 id="addin-pharmaverse4devsformat_test_that_file">Addin <code>pharmaverse4devs::format_test_that_file()</code><a class="anchor" aria-label="anchor" href="#addin-pharmaverse4devsformat_test_that_file"></a>
</h3>
<p>To ease the burden on developers for writing and adding tests we have
developed an Addin for formatting test_that test files according to
admiral programming standards. The Addin will add and update comments as
well as number or re-numbers the tests. To access the Addin, be sure to
install the {pharmaverse4devs} from Github.</p>
<p>To install the latest development version of the package directly
from GitHub use the following code:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"remotes"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"pharmaverse/pharmaverse4devs"</span><span class="op">)</span></span></code></pre></div>
<p>Then use the Addin button and select the “Format test_that test file”
as seen in the image. Be sure to have the test-file open and selected
when calling the Addin.</p>
<p><img src="unit_test_format_tests.png" width="120%"></p>
<p>The Addin will perform the following:</p>
<ul>
<li>Updates or adds the number of the tests in the comments and in the
<code>test_that()</code> call</li>
<li>Updates the comments based on the description provided in the
<code>test_that()</code> call</li>
<li>Updates the function name in the <code>test_that()</code> call. The
function name is extracted from the last
<code># &lt;function name&gt; ----</code> comment before the
<code>test_that()</code> call. If a test file tests more than one
function, such comments should be added before the first test of each
function. If a test files tests a single function only, the comments can
be omitted. In this case the addin determines the function name from the
file name by stripping of the “test-” prefix and the “.R” suffix.</li>
</ul>
<p>When writing new unit tests, just provide a description in the
<code>test_that()</code> call and if necessary the function name in a
<code># &lt;function name&gt; ----</code> comment:</p>
<pre><code># derive_vars_merged ----
test_that( "works if it merges all variables", {
  actual &lt;- derive_vars_merged(advs,
    dataset_add = adsl,
    by_vars = exprs(STUDYID, USUBJID)
  )

# convert_dtm_to_dtc ----
test_that("works if dtm is in correct format", {
  expect_equal(
    convert_dtm_to_dtc(as.POSIXct("2022-04-05 15:34:07 UTC")),
    "2022-04-05T15:34:07"
  )
})

test_that("Error is thrown if dtm is not in correct format", {
  expect_error(
    convert_dtm_to_dtc("2022-04-05T15:26:14"),
    "lubridate::is.instant(dtm) is not TRUE",
    fixed = TRUE
  )
})</code></pre>
<p>Call the addin and get:</p>
<pre><code># derive_vars_merged ----
## Test 1: derive_vars_merged ----
test_that( "derive_vars_merged Test 1: it merges all variables", {
  actual &lt;- derive_vars_merged(advs,
    dataset_add = adsl,
    by_vars = exprs(STUDYID, USUBJID)
  )

# convert_dtm_to_dtc ----
## Test 2: works if dtm is in correct format ----
test_that("convert_dtm_to_dtc Test 2: works if dtm is in correct format", {
  expect_equal(
    convert_dtm_to_dtc(as.POSIXct("2022-04-05 15:34:07 UTC")),
    "2022-04-05T15:34:07"
  )
})

## Test 3: Error is thrown if dtm is not in correct format ----
test_that("convert_dtm_to_dtc Test 3: Error is thrown if dtm is not in correct format", {
  expect_error(
    convert_dtm_to_dtc("2022-04-05T15:26:14"),
    "lubridate::is.instant(dtm) is not TRUE",
    fixed = TRUE
  )
})</code></pre>
<p>Once you have tested your unit test program, you can run all unit
tests from the console, as follows.</p>
<pre><code><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span><span class="op">)</span></span></code></pre>
<p>For running just the tests of the current file call</p>
<pre><code><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/devtools-deprecated.html" class="external-link">test_file</a></span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="automation-of-unit-tests">Automation of Unit Tests<a class="anchor" aria-label="anchor" href="#automation-of-unit-tests"></a>
</h3>
<p>When a user actions a pull request in {admiral} GitHub repo, the unit
tests are automatically run and pull request will be denied if any unit
tests fail.</p>
</div>
<div class="section level3">
<h3 id="flow-chart">Flow Chart<a class="anchor" aria-label="anchor" href="#flow-chart"></a>
</h3>
<p><img src="unit_test_guidance.png" width="120%"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ben Straub, Stefan Bundfuss, Jeffrey Dickinson, Ross Farrugia, Fanny Gautier, Edoardo Mancini, Sadchla Mascary, Gordon Miller, Daniel Sjoberg, Stefan Thoma, Kangjie Zhang, Zelos Zhu, F. Hoffmann-La Roche AG, GlaxoSmithKline LLC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
