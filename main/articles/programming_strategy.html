<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="admiraldev">
<title>Programming Strategy • admiraldev</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Programming Strategy">
<meta property="og:description" content="admiraldev">
<meta property="og:image" content="https://pharmaverse.github.io/admiraldev/devel/main/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">admiraldev</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/admiraldev.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-developer-guides">Developer Guides</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-developer-guides">
    <a class="dropdown-item" href="../articles/development_process.html">Development Process</a>
    <a class="dropdown-item" href="../articles/programming_strategy.html">Programming Strategy</a>
    <a class="dropdown-item" href="../articles/writing_vignettes.html">Writing Vignettes</a>
    <a class="dropdown-item" href="../articles/unit_test_guidance.html">Unit Test Guidance</a>
    <a class="dropdown-item" href="../articles/git_usage.html">Guidance for git and GitHub Usage</a>
    <a class="dropdown-item" href="../articles/pr_review_guidance.html">Pull Request Review Guidance</a>
    <a class="dropdown-item" href="../articles/release_strategy.html">Release Strategy</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/pharmaverse/admiraldev" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Programming Strategy</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pharmaverse/admiraldev/blob/main/vignettes/programming_strategy.Rmd" class="external-link"><code>vignettes/programming_strategy.Rmd</code></a></small>
      <div class="d-none name"><code>programming_strategy.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>As <a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> is intended to be contributed by the user
community, this article is meant for developers that want to either
expand <a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> functionalities or build on top of
<a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a>. In order to keep the framework robust across the
whole community, we have defined a programming strategy that should be
followed in such cases. These contributions could include, for example,
company specific derivations of ADaM datasets.</p>
</div>
<div class="section level2">
<h2 id="functional-workflow">Functional Workflow<a class="anchor" aria-label="anchor" href="#functional-workflow"></a>
</h2>
<ul>
<li>Overall programming will follow a functional approach.</li>
<li>We mandate the use of tidyverse (e.g. dplyr) over similar
functionality existing in base R</li>
<li>Each ADaM dataset is built with a set of functions and not with free
flow code.</li>
<li>Each ADaM dataset has a specific programming workflow.</li>
<li>Each function has a specific purpose that supports the ADaM Dataset
programming workflow. It could be an <a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> function or
a company specific function.</li>
<li>Admiral functions can be re-used for company specific
functions.</li>
<li>Each function belongs to one category defined in
keywords/family.</li>
<li>Each function that is used to derive one or multiple variable(s) is
required to be unit tested.</li>
<li>Functions have a standard naming convention.</li>
<li>Double coding is not used as a QC method (only if absolutely
necessary).</li>
<li>ADaMs are created with readable, submission-ready code.</li>
</ul>
</div>
<div class="section level2">
<h2 id="functions-in-r">Functions in R<a class="anchor" aria-label="anchor" href="#functions-in-r"></a>
</h2>
<div class="section level3">
<h3 id="function-design">Function Design<a class="anchor" aria-label="anchor" href="#function-design"></a>
</h3>
<p>Firstly, it is important to explain how we decide on the need for new
derivation functions.</p>
<p>If a derivation rule or algorithm is common and highly similar across
different variables/parameters (e.g. study day or duration) then we
would provide a generic function that can be used to satisfy all the
times this may be needed across different ADaMs. Similarly, if we feel
that a certain derivation could be useful beyond a single purpose we
also would provide a generic function (e.g. instead of a last known
alive date function, we have an extreme date function where a user could
find the last date from a selection, or for example the first).</p>
<p>Otherwise, if we feel that a derivation rule is a unique need or
sufficiently complex to justify then we opt for a dedicated function for
that specific variable/parameter (e.g. treatment-emergent flag for
AEs).</p>
<p>If certain variables are closely connected (e.g. an imputed date and
the corresponding imputation flag) then a single function would provide
both variables.</p>
<p>If something needed for ADaM could be achieved simply via an existing
tidyverse function, then we do not wrap this into an admiral function,
as that would add an unnecessary extra layer for users.</p>
<p>The following principles are key when designing a new function:</p>
<ul>
<li><p><em><strong>Modularity</strong></em> - All code follows a modular
approach, i.e. the steps must be clearly separated and have a dedicated
purpose. This applies to scripts creating a dataset where each module
should create a single variable or parameter. But also to complex
derivations with several steps. Commenting on these steps is key for
readability.</p></li>
<li><p><em><strong>Avoid Copy and Paste</strong></em> - If the same or
very similar code is used multiple times, it should be put into a
separate function. This improves readability and maintainability and
makes unit testing easier. This should not be done for every simple
programming step where tidyverse can be used. But rather for
computational functions or data checks. However, also consider not to
nest too many functions.</p></li>
<li><p><em><strong>Checks</strong></em> - Whenever a function fails, a
meaningful error message must be provided with a clear reference to the
input which caused the failure. A users should not have to dig into
detailed code if they only want to apply a function. A meaningful error
message supports usability.</p></li>
<li>
<p><em><strong>Flexibility</strong></em> - Functions should be as
flexible as possible as long as it does not reduce the usability. For
example:</p>
<ul>
<li><p>The source variables or newly created variables and conditions
for selecting observations should not be hard-coded.</p></li>
<li><p>It is useful if an argument triggers optional steps, e.g. if the
<code>filter</code> argument is specified, the input dataset is
restricted, otherwise this step is skipped.</p></li>
<li><p>However, arguments should not trigger completely different
algorithms. For example <code>BNRIND</code> could be derived based on
<code>BASE</code> or based on <code>ANRIND</code>. It should not be
implemented within one function as the algorithms are completely
different. If <code>BASE</code> is used, the values are categorized
while if <code>ANRIND</code> is used, the values are merged from the
baseline observation.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="input-output-and-side-effects">Input, Output, and Side-effects<a class="anchor" aria-label="anchor" href="#input-output-and-side-effects"></a>
</h3>
<ul>
<li>The behavior of the function is only determined by its input, not by
any global object,<br>
i.e. all input like datasets, variable names, options, … must be
provided to the function by arguments.</li>
<li>It is expected that the input datasets are not grouped. If any are
grouped, the function must issue an error.</li>
<li>If a function requires grouping, the function must provide the
<code>by_vars</code> argument.</li>
<li>The output dataset must be ungrouped.</li>
<li>The functions should not sort (arrange) the output dataset at the
end.</li>
<li>If the function needs to create temporary variables in an input
dataset, names for these variables must be generated by
<code><a href="../reference/get_new_tmp_var.html">get_new_tmp_var()</a></code> to avoid that variables of the input
dataset are accidentally overwritten. The temporary variables must be
removed from the output dataset by calling
<code><a href="../reference/remove_tmp_vars.html">remove_tmp_vars()</a></code>.</li>
<li>If developers find the need to use or create <em>environment</em>
objects to achieve flexibility, use the <code>admiral_environment</code>
environment object created in <code>admiral_environment.R</code>. All
objects which are stored in this environment must be documented in
<code>admiral_environment.R</code>. An equivalent environment object and
<code>.R</code> file exist for admiraldev as well. For more details how
environments work, see relevant sections on environments in <a href="https://r-pkgs.org" class="external-link">R Packages</a> and <a href="https://adv-r.hadley.nz" class="external-link">Advanced R</a> textbooks.</li>
<li>In general, the function must not have any side-effects like
creating or modifying global objects, printing, writing files, …</li>
</ul>
</div>
<div class="section level3">
<h3 id="admiral-options">Admiral Options<a class="anchor" aria-label="anchor" href="#admiral-options"></a>
</h3>
<ul>
<li>An exception is made for admiral options, see
<code>get_admiral_option()</code> and
<code>set_admiral_options()</code>, where we have certain pre-defined
defaults with added flexibility to allow for user-defined defaults on
<em>commonly used</em> function arguments e.g. <code>subject_keys</code>
currently pre-defined as <code>exprs(STUDYID, USUBJID)</code>, but can
be modified using
<code>set_admiral_options(subject_keys = exprs(...))</code> at the top
of a script. The reasoning behind this was to relieve the user of
repeatedly changing aforementioned <em>commonly used</em> function
arguments multiple times in a script, which may be called across many
admiral functions.</li>
<li>If this additional flexibility needs to be added for another
<em>commonly used</em> function argument e.g. <code>future_input</code>
to be set as <code>exprs(...)</code> it can be added as an admiral
option. In the function formals define
<code>future_input = get_admiral_option("future_input")</code> then
proceed to modify the body and roxygen documentation of
<code>set_admiral_options()</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="function-names">Function Names<a class="anchor" aria-label="anchor" href="#function-names"></a>
</h3>
<ul>
<li>Function names should start with a verb and use snake case,
e.g. <code>derive_var_base()</code>.</li>
</ul>
<table class="table">
<colgroup>
<col width="31%">
<col width="68%">
</colgroup>
<thead><tr class="header">
<th>Function name prefix</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>
<code>assert_</code> / <code>warn_</code> / <code>is_</code>
</td>
<td>Functions that check other functions’ inputs</td>
</tr>
<tr class="even">
<td><code>derive_</code></td>
<td>Functions that take a dataset as input and return a new dataset with
additional rows and/or columns</td>
</tr>
<tr class="odd">
<td>
<code>derive_var_</code> (e.g. <code>derive_var_trtdurd</code>)</td>
<td>Functions which add a single variable</td>
</tr>
<tr class="even">
<td>
<code>derive_vars_</code> (e.g. <code>derive_vars_dt</code>)</td>
<td>Functions which add multiple variables</td>
</tr>
<tr class="odd">
<td>
<code>derive_param_</code> (e.g. <code>derive_param_os</code>)</td>
<td>Functions which add a single parameter</td>
</tr>
<tr class="even">
<td>
<code>compute_</code> / <code>calculate_</code> / …</td>
<td>Functions that take vectors as input and return a vector</td>
</tr>
<tr class="odd">
<td>
<code>create_</code> / <code>consolidate_</code>
</td>
<td>Functions that create datasets without keeping the original
observations</td>
</tr>
<tr class="even">
<td><code>get_</code></td>
<td>Usually utility functions that return very specific objects that get
passed through other functions</td>
</tr>
<tr class="odd">
<td><code>filter_</code></td>
<td>Functions that filter observations based on conditions associated
with common clinical trial syntax</td>
</tr>
</tbody>
</table>
<table class="table">
<colgroup>
<col width="31%">
<col width="68%">
</colgroup>
<thead><tr class="header">
<th>Function Name Suffix</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>
<code>_derivation</code> (suffix)</td>
<td>High order functions that call a user specified derivation</td>
</tr>
<tr class="even">
<td>
<code>_date</code> / <code>_time</code> / <code>_dt</code> /
<code>_dtc</code> / <code>_dtm</code>
</td>
<td>Functions associated with dates, times, datetimes, and their
character equivalents.</td>
</tr>
<tr class="odd">
<td><code>_source</code></td>
<td>Functions that create source datasets that usually will be passed
through other <code>derive_</code> functions.</td>
</tr>
</tbody>
</table>
<table class="table">
<colgroup>
<col width="31%">
<col width="68%">
</colgroup>
<thead><tr class="header">
<th>Other Common Function Name Terms</th>
<th>Description</th>
</tr></thead>
<tbody><tr class="odd">
<td>
<code>_merged_</code> / <code>_joined_</code> /
<code>_extreme_</code>
</td>
<td>Functions that follow the generic function user-guide.</td>
</tr></tbody>
</table>
<p>Please note that the appropriate <em>var</em>/<em>vars</em> prefix
should be used for all cases in which the function creates any
variable(s), regardless of the presence of a <code>new_var</code>
argument in the function call.</p>
</div>
<div class="section level3">
<h3 id="function-arguments">Function Arguments<a class="anchor" aria-label="anchor" href="#function-arguments"></a>
</h3>
<p>The default value of optional arguments should be
<code>NULL</code>.</p>
<p>There is a recommended argument order that all contributors are asked
to adhere to (in order to keep consistency across functions):</p>
<ol style="list-style-type: decimal">
<li>
<code>dataset</code> (and any additional datasets denoted by
<code>dataset_*</code>)</li>
<li><code>by_vars</code></li>
<li><code>order</code></li>
<li>
<code>new_var</code> (and any related <code>new_var_*</code>
arguments)</li>
<li>
<code>filter</code> (and any additional filters denoted by
<code>filter_*</code>)</li>
<li>all additional arguments:
<ul>
<li>Make sure to always mention <code>start_date</code> before
<code>end_date</code> (or related).</li>
</ul>
</li>
</ol>
<p>Names of variables inside a dataset should be passed as symbols
rather than strings, i.e. <code>AVAL</code> rather than
<code>"AVAL"</code>. If an argument accepts one or more variables or
expressions as input then the variables and expressions should be
wrapped inside <code><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs()</a></code>.</p>
<p>For example:</p>
<ul>
<li><code>new_var = TEMPBL</code></li>
<li><code>by_vars = exprs(PARAMCD, AVISIT)</code></li>
<li><code>filter = PARAMCD == "TEMP"</code></li>
<li><code>order = exprs(AVISIT, desc(AESEV))</code></li>
<li><code>new_vars = exprs(LDOSE = EXDOSE, LDOSEDT = convert_dtc_to_dt(EXSTDTC))</code></li>
</ul>
<p>Each function argument needs to be tested with <code>assert_</code>
type of function.</p>
<p>Each expression needs to be tested for the following (there are many
utility functions in <a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> available to the
contributor):</p>
<ul>
<li>whether it is an expression (or a list of expressions, depending on
the function)</li>
<li>whether it is a valid expression (i.e. whether it evaluates without
error)</li>
</ul>
</div>
<div class="section level3">
<h3 id="common-function-arguments-naming-convention">Common Function Arguments Naming Convention<a class="anchor" aria-label="anchor" href="#common-function-arguments-naming-convention"></a>
</h3>
<p>The first argument of <code>derive_</code> functions should be the
input dataset and it should be named <code>dataset</code>. If more than
one input dataset is required, the other input dataset should start with
<code>dataset_</code>, e.g., <code>dataset_ex.</code></p>
<p>Arguments for specifying items to add should start with
<code>new_</code>. If a variable is added, the second part of the
argument name should be var, if a parameter is added, it should be
<code>param.</code> For example: <code>new_var</code>,
<code>new_var_unit</code>, <code>new_param</code>.</p>
<p>Arguments which expect a boolean or boolean vector must start with a
verb, e.g., <code>is_imputed</code> or <code>impute_date</code>.</p>
</div>
<div class="section level3">
<h3 id="list-of-common-arguments">List of Common Arguments<a class="anchor" aria-label="anchor" href="#list-of-common-arguments"></a>
</h3>
<table class="table">
<colgroup>
<col width="13%">
<col width="86%">
</colgroup>
<thead><tr class="header">
<th>Argument Name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>dataset</code></td>
<td>The input dataset. Expects a data.frame or a tibble.</td>
</tr>
<tr class="even">
<td><code>by_vars</code></td>
<td>Variables to group by.</td>
</tr>
<tr class="odd">
<td><code>order</code></td>
<td>List of expressions for sorting a dataset, e.g.,
<code>exprs(PARAMCD, AVISITN, desc(AVAL))</code>.</td>
</tr>
<tr class="even">
<td><code>new_var</code></td>
<td>Name of a single variable to be added to the dataset.</td>
</tr>
<tr class="odd">
<td><code>new_vars</code></td>
<td>List of variables to be added to the dataset.</td>
</tr>
<tr class="even">
<td><code>new_var_unit</code></td>
<td>Name of the unit variable to be added. It should be the unit of the
variable specified for the <code>new_var</code> argument.</td>
</tr>
<tr class="odd">
<td><code>filter</code></td>
<td>Expression to filter a dataset, e.g.,
<code>PARAMCD == "TEMP"</code>.</td>
</tr>
<tr class="even">
<td><code>start_date</code></td>
<td>The start date of an event/interval. Expects a date object.</td>
</tr>
<tr class="odd">
<td><code>end_date</code></td>
<td>The end date of an event/interval. Expects a date object.</td>
</tr>
<tr class="even">
<td><code>start_dtc</code></td>
<td>(Partial) start date/datetime in ISO 8601 format.</td>
</tr>
<tr class="odd">
<td><code>dtc</code></td>
<td>(Partial) date/datetime in ISO 8601 format.</td>
</tr>
<tr class="even">
<td><code>date</code></td>
<td>Date of an event / interval. Expects a date object.</td>
</tr>
<tr class="odd">
<td><code>set_values_to</code></td>
<td>List of variable name-value pairs. Use
<code><a href="../reference/process_set_values_to.html">process_set_values_to()</a></code> for processing the value and
providing user friendly error messages.</td>
</tr>
<tr class="even">
<td><code>subject_keys</code></td>
<td>Variables to uniquely identify a subject, defaults to
<code>exprs(STUDYID, USUBJID)</code>. In function formals, use
<code>subject_keys = get_admiral_option("subject_keys")</code>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="source-code-formatting">Source Code Formatting<a class="anchor" aria-label="anchor" href="#source-code-formatting"></a>
</h3>
<p>All source code should be formatted according to the <a href="https://style.tidyverse.org/" class="external-link">tidyverse</a> style guide. The <a href="https://github.com/jimhester/lintr" class="external-link">lintr</a> and <a href="https://github.com/r-lib/styler" class="external-link">styler</a> packages are used to
check and enforce this.</p>
</div>
<div class="section level3">
<h3 id="comments">Comments<a class="anchor" aria-label="anchor" href="#comments"></a>
</h3>
<p>Comments should be added to help other readers than the author to
understand the code. There are two main cases:</p>
<ul>
<li>
<p>If the intention of a chunk of code is not clear, a comment
should be added. The comment should not rephrase the code but provide
additional information.</p>
<p><em>Bad</em></p>
<pre><code><span class="co"># If AVAL equals zero, set it to 0.0001. Otherwise, do not change it</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">dataset</span>, AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0.0001</span>, <span class="va">AVAL</span><span class="op">)</span><span class="op">)</span></code></pre>
<p><em>Good</em></p>
<pre><code><span class="co"># AVAL is to be displayed on a logarithmic scale.</span>
  <span class="co"># Thus replace zeros by a small value to avoid gaps.</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">dataset</span>, AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">AVAL</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0.0001</span>, <span class="va">AVAL</span><span class="op">)</span><span class="op">)</span></code></pre>
</li>
<li>
<p>For long functions (&gt;100 lines) comments can be added to
structure the code and simplify navigation. In this case the comment
should end with <code>----</code> to add an entry to the document
outline in RStudio. For example:</p>
<pre><code><span class="co"># Check arguments ----</span></code></pre>
</li>
</ul>
<p>The formatting of the comments must follow the <a href="https://style.tidyverse.org/syntax.html#comments" class="external-link">tidyverse</a>
style guide. I.e., the comment should start with a single <code>#</code>
and a space. No decoration (except for outline entries) must be
added.</p>
<p><em>Bad</em></p>
<pre><code><span class="co"># This is a comment #</span>

<span class="co">###########################</span>
<span class="co"># This is another comment #</span>
<span class="co">###########################</span>

<span class="co">#+++++++++++++++++++++++++++++++</span>
<span class="co"># This is a section comment ----</span>
<span class="co">#+++++++++++++++++++++++++++++++</span></code></pre>
<p><em>Good</em></p>
<pre><code><span class="co"># This is a comment</span>

<span class="co"># This is another comment</span>

<span class="co"># This is a section comment ----</span></code></pre>
</div>
<div class="section level3">
<h3 id="input-checking">Input Checking<a class="anchor" aria-label="anchor" href="#input-checking"></a>
</h3>
<p>In line with the <a href="https://en.wikipedia.org/wiki/Fail-fast" class="external-link">fail-fast</a> design
principle, function inputs should be checked for validity and, if
there’s an invalid input, the function should stop immediately with an
error. An exception is the case where a variable to be added by a
function already exists in the input dataset: here only a warning should
be displayed and the function should continue executing.</p>
<p>Inputs should be checked using custom assertion functions defined in
<a href="https://github.com/pharmaverse/admiraldev/blob/main/R/assertions.R" class="external-link"><code>R/assertions.R</code></a>.
These custom assertion functions should either return an error in case
of an invalid input or return nothing.</p>
<p>For the most common types of input arguments like a single variable,
a list of variables, a dataset, … functions for checking are available
(see <a href="../reference/index.html#section-assertions">assertions</a>).</p>
<p>Arguments which expect keywords should handle them in a
case-insensitive manner, e.g., both
<code>date_imputation = "FIRST"</code> and
<code>date_imputation = "first"</code> should be accepted. The
<code><a href="../reference/assert_character_scalar.html">assert_character_scalar()</a></code> function helps with handling
arguments in a case-insensitive manner.</p>
<p>A argument should not be checked in an outer function if the argument
name is the same as in the inner function. This rule is applicable only
if both functions are part of <a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a>.</p>
</div>
<div class="section level3">
<h3 id="function-header-documentation">Function Header (Documentation)<a class="anchor" aria-label="anchor" href="#function-header-documentation"></a>
</h3>
<p>Every function that is exported from the package must have an
accompanying header that should be formatted according to the <a href="https://roxygen2.r-lib.org/" class="external-link">roxygen2</a> convention.</p>
<p>In addition to the roxygen2 tags, <code>@keywords</code> is also
used.</p>
<p>The keywords are used to categorize the function. Please see section
“Categorization of functions”.</p>
<p>An example is given below:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Derive Relative Day Variables</span>
<span class="co">#'</span>
<span class="co">#' Adds relative day variables (`--DY`) to the dataset, e.g., `ASTDY` and</span>
<span class="co">#' `AENDY`.</span>
<span class="co">#'</span>
<span class="co">#' @param dataset Input dataset</span>
<span class="co">#'</span>
<span class="co">#'   The columns specified by the `reference_date` and the `source_vars`</span>
<span class="co">#'   argument are expected.</span>
<span class="co">#'</span>
<span class="co">#' @param reference_date The start date column, e.g., date of first treatment</span>
<span class="co">#'</span>
<span class="co">#'   A date or date-time object column is expected.</span>
<span class="co">#'</span>
<span class="co">#'   Refer to `derive_var_dt()` to impute and derive a date from a date</span>
<span class="co">#'   character vector to a date object.</span>
<span class="co">#'</span>
<span class="co">#' @param source_vars A list of datetime or date variables created using</span>
<span class="co">#'   `exprs()` from which dates are to be extracted. This can either be a list of</span>
<span class="co">#'   date(time) variables or named `--DY` variables and corresponding --DT(M)</span>
<span class="co">#'   variables e.g. `exprs(TRTSDTM, ASTDTM, AENDT)` or `exprs(TRTSDT, ASTDTM,</span>
<span class="co">#'   AENDT, DEATHDY = DTHDT)`. If the source variable does not end in --DT(M), a</span>
<span class="co">#'   name for the resulting `--DY` variable must be provided.</span>
<span class="co">#'</span>
<span class="co">#' @details The relative day is derived as number of days from the reference</span>
<span class="co">#'   date to the end date. If it is nonnegative, one is added. I.e., the</span>
<span class="co">#'   relative day of the reference date is 1. Unless a name is explicitly</span>
<span class="co">#'   specified, the name of the resulting relative day variable is generated</span>
<span class="co">#'   from the source variable name by replacing DT (or DTM as appropriate) with</span>
<span class="co">#'   DY.</span>
<span class="co">#'</span>
<span class="co">#' @return The input dataset with `--DY` corresponding to the `--DTM` or `--DT`</span>
<span class="co">#'   source variable(s) added</span>
<span class="co">#'</span>
<span class="co">#' @keywords der_date_time</span>
<span class="co">#' @family der_date_time</span>
<span class="co">#'</span>
<span class="co">#' @export</span>
<span class="co">#'</span>
<span class="co">#' @examples</span>
<span class="co">#' library(lubridate)</span>
<span class="co">#' library(dplyr, warn.conflicts = FALSE)</span>
<span class="co">#' library(tibble)</span>
<span class="co">#'</span>
<span class="co">#' datain &lt;- tribble(</span>
<span class="co">#'   ~TRTSDTM,              ~ASTDTM,               ~AENDT,</span>
<span class="co">#'   "2014-01-17T23:59:59", "2014-01-18T13:09:O9", "2014-01-20"</span>
<span class="co">#' ) %&gt;%</span>
<span class="co">#'   mutate(</span>
<span class="co">#'     TRTSDTM = as_datetime(TRTSDTM),</span>
<span class="co">#'     ASTDTM = as_datetime(ASTDTM),</span>
<span class="co">#'     AENDT = ymd(AENDT)</span>
<span class="co">#'   )</span>
<span class="co">#'</span>
<span class="co">#' derive_vars_dy(</span>
<span class="co">#'   datain,</span>
<span class="co">#'   reference_date = TRTSDTM,</span>
<span class="co">#'   source_vars = exprs(TRTSDTM, ASTDTM, AENDT)</span>
<span class="co">#' )</span></code></pre></div>
<p>The following fields are mandatory:</p>
<ul>
<li>
<code>@param</code>: One entry per function argument. The following
attributes should be described: expected data type
(e.g. <code>data.frame</code>, <code>logical</code>,
<code>numeric</code> etc.), permitted values (if applicable),
optionality (i.e. is this a required argument). If the expected input is
a dataset then the required variables should be clearly stated.
Describing the default value becomes difficult to maintain and subject
to manual error when it is already declared in the function arguments.
The description for permitted values should be written as a separate
line italicizing the phrase “Permitted Values”, example below:</li>
</ul>
<pre><code><span class="co">#'   *Permitted Values*: example description of permitted values here</span></code></pre>
<ul>
<li>
<code>@details</code>: A natural-language description of the
derivation used inside the function.</li>
<li>
<code>@keyword</code>: One applicable tag to the function -
identical to family.</li>
<li>
<code>@family</code>: One applicable tag to the function - identical
to keyword.</li>
<li>
<code>@return</code>: A description of the return value of the
function. Any newly added variable(-s) should be mentioned here.</li>
<li>
<code>@examples</code>: A fully self-contained example of how to use
the function. Self-contained means that, if this code is executed in a
new R session, it will run without errors. That means any packages need
to be loaded with <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library()</a></code> and any datasets needed either
to be created directly inside the example code or loaded using
<code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code>. If a dataset is created in the example, it should
be done so using the function <code><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble()</a></code> (specify
<code><a href="https://tibble.tidyverse.org/" class="external-link">library(tibble)</a></code> before calling this function). If other
functions are called in the example, please specify
<code><a href="https://rdrr.io/r/base/library.html" class="external-link">library(pkg_name)</a></code> then refer to the respective function
<code>fun()</code> as opposed to the preferred
<code>pkg_name::fun()</code> notation as specified in <a href="unit_test_guidance.html#set-up-the-test-script">Unit Test
Guidance</a>. Make sure to align columns as this ensures quick code
readability.</li>
</ul>
<p>Copying descriptions should be avoided as it makes the documentation
hard to maintain. For example if the same argument with the same
description is used by more than one function, the argument should be
described for one function and the other functions should use
<code>@inheritParams &lt;function name where the argument is described&gt;</code>.</p>
<p>Please note that if <code>@inheritParams func_first</code> is used in
the header of the <code>func_second()</code> function, those argument
descriptions of <code>func_first()</code> are included in the
documentation of <code>func_second()</code> for which</p>
<ul>
<li>the argument is offered by <code>func_second()</code> and</li>
<li>no <code>@param</code> tag for the argument is included in the
header of <code>func_second()</code>.</li>
</ul>
<p>The order of the <code>@param</code> tags should be the same as in
the function definition. The <code>@inheritParams</code> tags should be
after the <code>@param</code>. This does not affect the order of the
argument description in the rendered documentation but makes it easier
to maintain the headers.</p>
<p>Variable names, expressions, functions, and any other code must be
enclosed which backticks. This will render it as code.</p>
<p>For functions which derive a specific CDISC variable, the title must
state the label of the variable without the variable name. The variable
should be stated in the description.</p>
</div>
<div class="section level3">
<h3 id="categorization-of-functions">Categorization of Functions<a class="anchor" aria-label="anchor" href="#categorization-of-functions"></a>
</h3>
<p>The functions are categorized by keywords and families within the
roxygen header. Categorization is important as the <code>admiral</code>
user-facing functions base totals above 125 and is growing! However, to
ease the burden for developers, we have decided that the keywords and
families should be identical in the roxygen header, which are specified
via the <code>@keywords</code> and <code>@family</code> fields. To
reiterate, each function must use the <strong>same keyword and
family</strong>. Also, please note that the keywords and families are
case-sensitive.</p>
<div class="section level4">
<h4 id="keywords">
<code>@keywords</code><a class="anchor" aria-label="anchor" href="#keywords"></a>
</h4>
<p>The keywords allows for the reference page to be easily organized
when using certain <code>pgkdown</code> functions. For example, using
the function <code>has_keyword(der_bds_gen)</code> in the
<code>_pkgdown.yml</code> file while building the website will collect
all the BDS General Derivation functions and display them in
alphabetical order on the Reference Page in a section called
BDS-Specific.</p>
</div>
<div class="section level4">
<h4 id="family">
<code>@family</code><a class="anchor" aria-label="anchor" href="#family"></a>
</h4>
<p>The families allow for similar functions to be displayed in the
<strong>See Also</strong> section of a function’s documentation. For
example, a user looking at <code>derive_vars_dy()</code> function
documentation might be interested in other Date/Time functions. Using
the <code>@family</code> tag <code>der_date_time</code> will display all
the Date/Time functions available in admiral to the user in the
<strong>See Also</strong> section of <code>derive_vars_dy()</code>
function documentation. Please take a look at the function documentation
for <code>derive_vars_dy()</code> to see the family tag in action.</p>
<p>Below are the list of available keyword/family tags to be used in
<code>admiral</code> functions. If you think an additional
keyword/family tag should be added, then please add an issue in GitHub
for discussion.</p>
<table class="table">
<colgroup>
<col width="40%">
<col width="59%">
</colgroup>
<thead><tr class="header">
<th>Keyword/Family</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>com_date_time</code></td>
<td>Date/Time Computation Functions that returns a vector</td>
</tr>
<tr class="even">
<td><code>com_bds_findings</code></td>
<td>BDS-Findings Functions that returns a vector</td>
</tr>
<tr class="odd">
<td><code>create_aux</code></td>
<td>Functions for Creating Auxiliary Datasets</td>
</tr>
<tr class="even">
<td><code>datasets</code></td>
<td>Example datasets used within admiral</td>
</tr>
<tr class="odd">
<td><code>der_gen</code></td>
<td>General Derivation Functions that can be used for any ADaM.</td>
</tr>
<tr class="even">
<td><code>der_date_time</code></td>
<td>Date/Time Derivation Function</td>
</tr>
<tr class="odd">
<td><code>der_bds_gen</code></td>
<td>Basic Data Structure (BDS) Functions that can be used across
different BDS ADaM (adex, advs, adlb, etc)</td>
</tr>
<tr class="even">
<td><code>der_bds_findings</code></td>
<td>Basic Data Structure (BDS) Functions specific to the BDS-Findings
ADaMs</td>
</tr>
<tr class="odd">
<td><code>der_prm_bds_findings</code></td>
<td>BDS-Findings Functions for adding Parameters</td>
</tr>
<tr class="even">
<td><code>der_adsl</code></td>
<td>Functions that can only be used for creating ADSL.</td>
</tr>
<tr class="odd">
<td><code>der_tte</code></td>
<td>Function used only for creating a Time to Event (TTE) Dataset</td>
</tr>
<tr class="even">
<td><code>der_occds</code></td>
<td>OCCDS specific derivation of helper Functions</td>
</tr>
<tr class="odd">
<td><code>der_prm_tte</code></td>
<td>TTE Functions for adding Parameters to TTE Dataset</td>
</tr>
<tr class="even">
<td><code>deprecated</code></td>
<td>Function which will be removed from admiral after next release. See
<a href="#deprecation">Deprecation Guidance</a>.</td>
</tr>
<tr class="odd">
<td><code>metadata</code></td>
<td>Auxiliary datasets providing definitions as input for derivations,
e.g. grading criteria or dose frequencies</td>
</tr>
<tr class="even">
<td><code>utils_ds_chk</code></td>
<td>Utilities for Dataset Checking</td>
</tr>
<tr class="odd">
<td><code>utils_fil</code></td>
<td>Utilities for Filtering Observations</td>
</tr>
<tr class="even">
<td><code>utils_fmt</code></td>
<td>Utilities for Formatting Observations</td>
</tr>
<tr class="odd">
<td><code>utils_print</code></td>
<td>Utilities for Printing Objects in the Console</td>
</tr>
<tr class="even">
<td><code>utils_help</code></td>
<td>Utilities used within Derivation functions</td>
</tr>
<tr class="odd">
<td><code>utils_examples</code></td>
<td>Utilities used for examples and template scripts</td>
</tr>
<tr class="even">
<td><code>source_specifications</code></td>
<td>Source Objects</td>
</tr>
<tr class="odd">
<td><code>other_advanced</code></td>
<td>Other Advanced Functions</td>
</tr>
<tr class="even">
<td><code>high_order_function</code></td>
<td>Higher Order Functions</td>
</tr>
<tr class="odd">
<td><code>internal</code></td>
<td>Internal functions only available to admiral developers</td>
</tr>
<tr class="even">
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>
<code>assertion</code>*</td>
<td>Asserts a certain type and gives warning, error to user</td>
</tr>
<tr class="even">
<td><code>warning</code></td>
<td>Provides custom warnings to user</td>
</tr>
<tr class="odd">
<td><code>what</code></td>
<td>A function that …</td>
</tr>
<tr class="even">
<td><code>is</code></td>
<td>A function that …</td>
</tr>
<tr class="odd">
<td><code>get</code></td>
<td>A function that …</td>
</tr>
</tbody>
</table>
<p><strong>NOTE:</strong> It is strongly encouraged that each
<code>@keyword</code> and <code>@family</code> are to be identical. This
eases the burden of development and maintenance for admiral functions.
If you need to use multiple keywords or families, please reach out to
the core development team for discussion.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="missing-values">Missing values<a class="anchor" aria-label="anchor" href="#missing-values"></a>
</h2>
<p>Missing values (<code>NA</code>s) need to be explicitly shown.</p>
<p>Regarding character vectors converted from SAS files: SAS treats
missing character values as blank. Those are imported into R as empty
strings (<code>""</code>) although in nature they are missing values
(<code>NA</code>). All empty strings that originate like this need to be
converted to proper R missing values <code>NA</code>.</p>
</div>
<div class="section level2">
<h2 id="file-structuring">File Structuring<a class="anchor" aria-label="anchor" href="#file-structuring"></a>
</h2>
<p>Organizing functions into files is more of an art than a science.
Thus, there are no hard rules but just recommendations. First and
foremost, there are two extremes that should be avoided: putting each
function into its own file and putting all functions into a single file.
Apart from that the following recommendations should be taken into
consideration when deciding upon file structuring:</p>
<ul>
<li>If a function is very long (together with its documentation), store
it in a separate file</li>
<li>If some functions are documented together, put them into one
file</li>
<li>If some functions have some sort of commonality or relevance with
one another (like <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">dplyr::bind_rows()</a></code> and
<code><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">dplyr::bind_cols()</a></code>), put them into one file</li>
<li>Store functions together with their helpers and methods</li>
<li>Have no more than 1000 lines in a single file, unless necessary
(exceptions are, for example, classes with methods)</li>
</ul>
<p>It is the responsibility of both the author of a new function and
reviewer to ensure that these recommendations are put into practice.</p>
</div>
<div class="section level2">
<h2 id="r-package-dependencies">R Package Dependencies<a class="anchor" aria-label="anchor" href="#r-package-dependencies"></a>
</h2>
<p>Package dependencies have to be documented in the
<code>DESCRIPTION</code> file. If a package is used only in examples
and/or unit tests then it should be listed in <code>Suggests</code>,
otherwise in <code>Imports</code>.</p>
<p>Functions from other packages have to be explicitly imported by using
the <code>@importFrom</code> tag in the <code>R/admiral-package.R</code>
file. To import the <code><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code>
function from <code>dplyr</code> the following line would have to be
included in that file: <code>#' @importFrom dplyr if_else mutate</code>.
By using the <code>@importFrom</code> tag, it is easier to track all of
our dependencies in one place and improves code readability.</p>
<p>Some of these functions become critically important while using
admiral and should be included as an export. This applies to functions
which are frequently called within <code>{admiral }</code>function calls
like <code><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">rlang::exprs()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">dplyr::desc()</a></code> or the pipe
operator <code>magrittr::%&gt;%</code>. To export these functions, the
following R code should be included in the <code>R/reexports.R</code>
file using the format:</p>
<pre><code><span class="co">#' @export</span>
<span class="fu">pkg_name</span><span class="fu">::</span><span class="va">fun</span></code></pre>
</div>
<div class="section level2">
<h2 id="metadata">Metadata<a class="anchor" aria-label="anchor" href="#metadata"></a>
</h2>
<p>Functions should only perform the derivation logic and not add any
kind of metadata, e.g. labels.</p>
</div>
<div class="section level2">
<h2 id="unit-testing">Unit Testing<a class="anchor" aria-label="anchor" href="#unit-testing"></a>
</h2>
<p>A function requires a set of unit tests to verify it produces the
expected result. See <a href="unit_test_guidance.html#writing-unit-tests-in-admiral">Writing
Unit Tests in {admiral}</a> for details.</p>
</div>
<div class="section level2">
<h2 id="deprecation">Deprecation<a class="anchor" aria-label="anchor" href="#deprecation"></a>
</h2>
<p>As <a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> is still evolving, functions or arguments
may need to be removed or replaced with more efficient options from one
release to another. In such cases, the relevant function or argument
must be marked as deprecated. This deprecation is done in three phases
over our release cycles.</p>
<ul>
<li><p><strong>Phase 1:</strong> In the release where the identified
function or argument is to be deprecated there will be a warning issued
when using the function or argument using
<code>deprecate_warn()</code>.</p></li>
<li><p><strong>Phase 2:</strong> In the next release an error will be
thrown using <code>deprecate_stop()</code>.</p></li>
<li><p><strong>Phase 3:</strong> Finally in the 3rd release thereafter
the function will be removed from the package altogether.</p></li>
</ul>
<p>Information about deprecation timelines must be added to the
warning/error message.</p>
<p>Note that the deprecation cycle time for a function or argument based
on our current release schedule is 6 months.</p>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h3>
<p>If a function or argument is removed, the documentation must be
updated to indicate the function or the argument is now deprecated and
which new function/argument should be used instead.</p>
<p>The documentation will be updated at:</p>
<ul>
<li><p>the description level for a function,</p></li>
<li><p>the keywords will be replaced with
<code>deprecated</code></p></li>
<li>
<p>the <code>@family</code> roxygen tag will become
<code>deprecated</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Title of the function</span>
<span class="co">#'</span>
<span class="co">#' @description</span>
<span class="co">#' `r lifecycle::badge("deprecated")`</span>
<span class="co">#'</span>
<span class="co">#' This function is *deprecated*, please use `new_fun()` instead.</span>
<span class="co">#' .</span>
<span class="co">#' @family deprecated</span>
<span class="co">#'</span>
<span class="co">#' @keywords deprecated</span>
<span class="co">#' .</span></code></pre></div>
</li>
<li><p>the <code>@examples</code> section should be removed.</p></li>
<li>
<p>the <code>@param</code> level for a argument.</p>
<pre><code>@param old_param *Deprecated*, please use `new_param` instead.</code></pre>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="handling-of-warning-and-error">Handling of Warning and Error<a class="anchor" aria-label="anchor" href="#handling-of-warning-and-error"></a>
</h3>
<p>When a function or argument is deprecated, the function must be
updated to issue a warning or error using <code>deprecate_warn()</code>
and <code>deprecate_stop()</code>, respectively, as described above.</p>
<p>There should be a test case added in the test file of the function
that checks whether this warning/error is issued as appropriate when
using the deprecated function or argument.</p>
<div class="section level4">
<h4 id="function">Function<a class="anchor" aria-label="anchor" href="#function"></a>
</h4>
<p>In the initial release in which a function is deprecated the original
function body must be replaced with a call to
<code>deprecate_warn()</code> and subsequently all arguments should be
passed on to the new function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fun_xxx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span>, <span class="va">some_param</span>, <span class="va">other_param</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">deprecate_warn</span><span class="op">(</span><span class="st">"x.y.z"</span>, <span class="st">"fun_xxx()"</span>, <span class="st">"new_fun_xxx()"</span><span class="op">)</span>
  <span class="fu">new_fun_xxx</span><span class="op">(</span>
    dataset <span class="op">=</span> <span class="va">dataset</span>,
    some_param <span class="op">=</span> <span class="va">some_param</span>,
    other_param <span class="op">=</span> <span class="va">other_param</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>In the following release the function body should be changed to just
include a call to <code>deprecate_stop()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fun_xxx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span>, <span class="va">some_param</span>, <span class="va">other_param</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">deprecate_stop</span><span class="op">(</span><span class="st">"x.y.z"</span>, <span class="st">"fun_xxx()"</span>, <span class="st">"new_fun_xxx()"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Finally, in the next release the function should be removed from the
package.</p>
</div>
<div class="section level4">
<h4 id="argument">Argument<a class="anchor" aria-label="anchor" href="#argument"></a>
</h4>
<p>If an argument is removed and is not replaced, an
<strong>error</strong> must be generated:</p>
<pre><code><span class="co">### BEGIN DEPRECATION</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">old_param</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">deprecate_stop</span><span class="op">(</span><span class="st">"x.y.z"</span>, <span class="st">"fun_xxx(old_param = )"</span>, <span class="st">"fun_xxx(new_param = )"</span><span class="op">)</span>
  <span class="op">}</span>
<span class="co">### END DEPRECATION</span></code></pre>
<p>If the argument is renamed or replaced, a <strong>warning</strong>
must be issued and the new argument takes the value of the old argument
until the next release. Note: arguments which are not passed as
<code><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs()</a></code> argument (e.g. <code>new_var = VAR1</code> or
<code>filter = AVAL &gt;10</code>) will need to be quoted.</p>
<pre><code><span class="co">### BEGIN DEPRECATION</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">old_param</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">deprecate_warn</span><span class="op">(</span><span class="st">"x.y.z"</span>, <span class="st">"fun_xxx(old_param = )"</span>, <span class="st">"fun_xxx(new_param = )"</span><span class="op">)</span>
    <span class="co"># old_param is given using exprs()</span>
    <span class="va">new_param</span> <span class="op">&lt;-</span> <span class="va">old_param</span>
    <span class="co"># old_param is NOT given using exprs()</span>
    <span class="va">new_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">enexpr</a></span><span class="op">(</span><span class="va">old_param</span><span class="op">)</span>
  <span class="op">}</span>
<span class="co">### END DEPRECATION</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="unit-testing-1">Unit Testing<a class="anchor" aria-label="anchor" href="#unit-testing-1"></a>
</h3>
<p>Unit tests for deprecated functions and arguments must be added to
the test file <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;For example, if &lt;code&gt;derive_var_example()&lt;/code&gt; is
going to be deprecated and it is defined in &lt;code&gt;examples.R&lt;/code&gt;, the
unit tests are in &lt;code&gt;tests/testthat/test-examples.R&lt;/code&gt;.&lt;/p&gt;"><sup>1</sup></a> of the function to ensure that a warning or
error is issued.</p>
<p>When writing the unit test, check that the error or warning has the
right class, i.e., <code>"lifecycle_error_deprecated"</code> or
<code>"lifecycle_warning_deprecated"</code>, respectively. The unit-test
should follow the corresponding format, per the <a href="unit_test_guidance.html#writing-unit-tests-in-admiral">unit test
guidance</a>.</p>
<div class="section level4">
<h4 id="for-deprecated-functions-that-issues-a-warning-phase-1">For Deprecated Functions that Issues a Warning (Phase 1)<a class="anchor" aria-label="anchor" href="#for-deprecated-functions-that-issues-a-warning-phase-1"></a>
</h4>
<p>A unit test like the following must be added.</p>
<pre><code><span class="co">## Test #: deprecation warning if function is called ----</span>
<span class="fu">test_that</span><span class="op">(</span><span class="st">"derive_var_example() Test #: deprecation warning if function is called"</span>, <span class="op">{</span>
  <span class="fu">expect_warning</span><span class="op">(</span>
    <span class="fu">derive_var_example</span><span class="op">(</span><span class="op">)</span>,
    class <span class="op">=</span> <span class="st">"lifecycle_warning_deprecated"</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre>
<p>In the existing unit tests the call of the deprecated function need
to be enclosed by <code><a href="../reference/suppress_warning.html">suppress_warning()</a></code>. For example,</p>
<pre><code><span class="va">actual</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/suppress_warning.html">suppress_warning</a></span><span class="op">(</span>
    <span class="fu">derive_var_example</span><span class="op">(</span><span class="op">)</span>,
    regexpr <span class="op">=</span> <span class="st">"was deprecated"</span>
  <span class="op">)</span></code></pre>
<p>The <code>regexpr</code> argument must be specified to ensure that
only the deprecation warning is suppressed.</p>
</div>
<div class="section level4">
<h4 id="for-deprecated-functions-that-issues-an-error-phase-2">For Deprecated Functions that Issues an Error (Phase 2)<a class="anchor" aria-label="anchor" href="#for-deprecated-functions-that-issues-an-error-phase-2"></a>
</h4>
<p>A unit test like the following must be added.</p>
<pre><code><span class="co">## Test #: error if function is called ----</span>
<span class="fu">test_that</span><span class="op">(</span><span class="st">"derive_var_example() Test #: deprecation error if function is called"</span>, <span class="op">{</span>
  <span class="fu">expect_error</span><span class="op">(</span>
    <span class="fu">derive_var_example</span><span class="op">(</span><span class="op">)</span>,
    class <span class="op">=</span> <span class="st">"lifecycle_error_deprecated"</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre>
<p>Other unit tests of the deprecated function must be removed.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="best-practices-and-hints">Best Practices and Hints<a class="anchor" aria-label="anchor" href="#best-practices-and-hints"></a>
</h2>
<p>Please take the following list as recommendation and try to adhere to
its rules if possible.</p>
<ul>
<li>Arguments in function calls should be named except for the first
parameter
(e.g. <code>assert_data_frame(dataset, required_vars = exprs(var1, var2), optional = TRUE)</code>).</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">dplyr::if_else()</a></code> should be used when there are only two
conditions. Try to always set the <code>missing</code> argument whenever
appropriate.</li>
</ul>
</div>
<div class="section level2">
<h2 id="r-and-package-versions-for-development">R and Package Versions for Development<a class="anchor" aria-label="anchor" href="#r-and-package-versions-for-development"></a>
</h2>
<ul>
<li>The choice of R Version is not set in stone. However, a common
development environment is important to establish when working across
multiple companies and multiple developers. We currently work in the
earliest of the three latest R Versions. This need for a common
development environment also carries over for our choice of package
versions.<br>
</li>
<li>GitHub allows us through the Actions/Workflows to test
<a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> under several versions of R as well as several
versions of dependent R packages needed for <a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a>.
Currently we test <a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a> against the three latest R
Versions and the closest snapshots of packages to those R versions. You
can view this workflow and others on our <a href="https://github.com/pharmaverse/admiralci" class="external-link">admiralci GitHub
Repository</a>.</li>
<li>This common development allows us to easily re-create bugs and
provide solutions to each other issues that developers will
encounter.<br>
</li>
<li>Reviewers of Pull Requests when running code will know that their
environment is identical to the initiator of the Pull Request. This
ensures faster review times and higher quality Pull Request
reviews.</li>
<li>We achieve this common development environment by using a
<strong>lockfile</strong> created from the <a href="https://rstudio.github.io/renv/" class="external-link"><code>renv</code></a> package.
New developers will encounter a suggested <code><a href="https://rstudio.github.io/renv/reference/restore.html" class="external-link">renv::restore()</a></code>
in the console to revert or move forward your R version and package
versions.</li>
</ul>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Ben Straub, Stefan Bundfuss, Thomas Neitmann, Samia Kabi, Pooja Kumari, Syed Mubasheer, Ross Farrugia, Sadchla Mascary, Zelos Zhu, Jeffrey Dickinson, Ania Golab, F. Hoffmann-La Roche AG, GlaxoSmithKline LLC.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
